{% extends 'base.html' %}

{% block title %}Alert Management | SecurityPulse{% endblock %}

{% block content %}
<div class="animate-fade">
    <div style="margin-bottom: 2rem;">
        <h1 style="font-size: 1.875rem; font-weight: 700;">Alert Management</h1>
        <p style="color: var(--text-secondary)">Manage and resolve automated threat detections.</p>
    </div>

    <div class="table-card">
        <div class="table-header">
            <h3 style="font-weight: 600;">Active & Historical Alerts</h3>
        </div>
        <table>
            <thead>
                <tr>
                    <th>Alert ID</th>
                    <th>Threat Signal</th>
                    <th>Severity</th>
                    <th>Status</th>
                    <th>Assigned To</th>
                    <th>Created At</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for alert in alerts %}
                <tr>
                    <td>#{{ alert.id }}</td>
                    <td>
                        <div style="font-weight: 600;">{{ alert.event.get_event_type_display }}</div>
                        <div style="font-size: 0.75rem; color: var(--text-secondary)">Source: {{ alert.event.source_name }}</div>
                    </td>
                    <td>
                        <span class="badge badge-{{ alert.event.severity }}">
                            {{ alert.event.severity }}
                        </span>
                    </td>
                    <td>
                        <span style="display: inline-flex; align-items: center; gap: 0.5rem; font-size: 0.875rem; font-weight: 500; color: {% if alert.status == 'open' %}var(--accent-danger){% elif alert.status == 'acknowledged' %}var(--accent-warning){% else %}var(--accent-success){% endif %}">
                            <i class="fas {% if alert.status == 'open' %}fa-circle-exclamation{% elif alert.status == 'acknowledged' %}fa-clock{% else %}fa-check-circle{% endif %}"></i>
                            {{ alert.get_status_display }}
                        </span>
                    </td>
                    <td>
                        {% if alert.assigned_to %}
                            {{ alert.assigned_to.username }}
                        {% else %}
                            <span style="color: var(--text-secondary)">Unassigned</span>
                        {% endif %}
                    </td>
                    <td style="color: var(--text-secondary); font-size: 0.8rem;">
                        {{ alert.created_at|date:"M d, H:i" }}
                    </td>
                    <td>
                        {% if user.role == 'admin' %}
                            <button class="btn btn-primary" onclick="openResolutionModal('{{ alert.id }}', '{{ alert.status }}', '{{ alert.resolution_notes|default:''|escapejs }}')" style="padding: 0.4rem 0.8rem; font-size: 0.8rem;">
                                <i class="fas fa-edit"></i> Manage
                            </button>
                        {% else %}
                            <span style="font-size: 0.75rem; color: var(--text-secondary)">Admin Only</span>
                        {% endif %}
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" style="text-align: center; padding: 4rem; color: var(--text-secondary)">
                        No alerts generated. Only High and Critical events trigger alerts.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if alerts.has_other_pages %}
    <div style="display: flex; justify-content: center; align-items: center; gap: 1rem; margin-top: 1.5rem;">
        {% if alerts.has_previous %}
            <a href="?page={{ alerts.previous_page_number }}" class="btn" style="background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border-color); text-decoration: none;">
                <i class="fas fa-chevron-left"></i> Previous
            </a>
        {% endif %}

        <span style="color: var(--text-secondary); font-size: 0.875rem;">
            Page {{ alerts.number }} of {{ alerts.paginator.num_pages }}
        </span>

        {% if alerts.has_next %}
            <a href="?page={{ alerts.next_page_number }}" class="btn" style="background: var(--bg-card); color: var(--text-primary); border: 1px solid var(--border-color); text-decoration: none;">
                Next <i class="fas fa-chevron-right"></i>
            </a>
        {% endif %}
    </div>
    {% endif %}
</div>

<div id="resolution-modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 1000; align-items: center; justify-content: center;">
    <div class="auth-card" style="max-width: 500px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h3 id="modal-title">Manage Alert</h3>
            <button onclick="closeResolutionModal()" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 1.25rem;">&times;</button>
        </div>
        
        <form id="resolution-form">
            {% csrf_token %}
            <input type="hidden" name="alert_id" id="modal-alert-id">
            
            <div class="form-group">
                <label>Update Status</label>
                <select name="status" id="modal-status" class="form-control">
                    <option value="open">Open</option>
                    <option value="acknowledged">Acknowledged</option>
                    <option value="resolved">Resolved</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Resolution Notes</label>
                <textarea name="notes" id="modal-notes" class="form-control" rows="4" placeholder="Describe discovery or resolution steps..."></textarea>
            </div>
            
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                <button type="button" onclick="closeResolutionModal()" class="btn" style="flex: 1; background: var(--bg-input); color: var(--text-primary);">Cancel</button>
                <button type="button" onclick="updateAlertStatus()" class="btn btn-primary" style="flex: 1; justify-content: center;">Save Changes</button>
            </div>
        </form>
    </div>
</div>

<script>
    function openResolutionModal(id, status, notes) {
        document.getElementById('modal-alert-id').value = id;
        document.getElementById('modal-status').value = status;
        document.getElementById('modal-notes').value = notes;
        document.getElementById('modal-title').innerText = 'Manage Alert #' + id;
        document.getElementById('resolution-modal').style.display = 'flex';
    }

    function closeResolutionModal() {
        document.getElementById('resolution-modal').style.display = 'none';
    }

    function updateAlertStatus() {
        const alertId = document.getElementById('modal-alert-id').value;
        const newStatus = document.getElementById('modal-status').value;
        const notes = document.getElementById('modal-notes').value;

        fetch(`/alert_status_change/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
            body: JSON.stringify({
                alert_id: alertId,
                new_status: newStatus,
                resolution_notes: notes,
            }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                closeResolutionModal();
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error updating alert status:', error);
        });
    }
</script>
{% endblock %}
